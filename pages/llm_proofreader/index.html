<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLM Proofreader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        textarea {
            width: 100%;
            height: 200px;
        }

        button {
            margin-top: 10px;
            padding: 10px 20px;
        }

        select {
            margin-left: 10px;
        }

        .diff {
            white-space: pre-wrap;
            margin-top: 20px;
            /* font-family: monospace; */
        }

        .added {
            background-color: #d4fcdc;
        }

        .removed {
            background-color: #ffd6d6;
            text-decoration: line-through;
        }

        #paste-buttom {
            float: right;
            margin-bottom: 8px;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner-container {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>

<body>
    <h1>LLM Proofreader</h1>
    <label for="model">Choose OpenAI model:</label>
    <select id="model">
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4.5">gpt-4.5</option>
        <option value="gpt-4.1">gpt-4.1</option>
        <option value="gpt-4.1-mini" selected>gpt-4.1-mini</option>
        <option value="o3">o3</option>
        <option value="o4-mini">o4-mini</option>
    </select>
    <button onclick="pasteFromClipboard()" id="paste-buttom">Paste from Clipboard</button>

    <textarea id="inputText" placeholder="Paste your text here..."></textarea>
    <button onclick="submitText()">Submit</button>

    <div class="diff" id="outputDiff"></div>
    <div class="spinner-container" id="spinnerContainer" style="display: none;">
        <div class="spinner"></div>
    </div>

    <h3>System prompt</h3>
    <textarea id="systemPrompt" placeholder="Enter system prompt here..."></textarea>

    <script>
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('inputText').value = text;
            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                alert('Failed to read clipboard contents. Please ensure you have granted permission.');
            }
        }

        // Check for API key in local storage or prompt user
        let apiKey = localStorage.getItem('OPENAI_API_KEY');
        if (!apiKey) {
            apiKey = prompt("Please enter your OpenAI API Key:");
            if (apiKey) {
                localStorage.setItem('OPENAI_API_KEY', apiKey);
                window.OPENAI_API_KEY = apiKey;
            } else {
                alert("API Key is required to use this tool.");
                // Optionally disable the submit button or handle the lack of key
                document.querySelector('button').disabled = true;
            }
        } else {
            window.OPENAI_API_KEY = apiKey;
        }

        const defaultPrompt = "You are a diligent proofreader at a scientific journal. Read the given text for typos and clarity. Return an edited version with MINIMAL changes that preserves the meaning of the original text. Use SI units for quantities (s for seconds, km for kilometers, etc.).";

        // Initialize system prompt in textarea when page loads
        window.onload = function () {
            document.getElementById('systemPrompt').value = defaultPrompt;
        }

        async function submitText() {
            const input = document.getElementById('inputText').value;
            const model = document.getElementById('model').value;
            const systemPrompt = document.getElementById('systemPrompt').value;

            document.getElementById('spinnerContainer').style.display = 'block';
            document.getElementById('outputDiff').style.display = 'none';

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${window.OPENAI_API_KEY}`,
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: input }
                    ]
                })
            });

            const data = await response.json();
            const editedText = data.choices[0].message.content;
            displayDiff(input, editedText);

            document.getElementById('spinnerContainer').style.display = 'none';
            document.getElementById('outputDiff').style.display = 'block';
        }

        function displayDiff(original, edited) {
            const diffOutput = document.getElementById('outputDiff');
            const diff = Diff.diffWords(original, edited);
            diffOutput.innerHTML = diff.map(part => {
                const cls = part.added ? 'added' : part.removed ? 'removed' : '';
                return `<span class="${cls}">${part.value}</span>`;
            }).join('');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.0.0/dist/diff.min.js"></script>
</body>

</html>